rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if a user is a member of a care circle.
    // NOTE: This function is duplicated from firestore.rules because rules
    // for different services are not co-deployed and cannot share functions.
    function isMemberOfCircle(circleId) {
      // We check for the existence of a membership document in Firestore.
      // The document ID is a composite key: "{circleId}_{userId}"
      return exists(/databases/$(database)/documents/careCircleMemberships/$(circleId + '_' + request.auth.uid));
    }

    // Care circle photos - only members can read/write
    match /careCircles/{circleId}/photos/{fileName} {
      allow read, write: if request.auth != null && isMemberOfCircle(circleId);
    }

    // Care circle settings (reward photos, etc.) - only members can read/write
    match /careCircles/{circleId}/settings/{fileName} {
      allow read, write: if request.auth != null && isMemberOfCircle(circleId);
    }

    // Memories/audio answers - only members can read/write
    match /careCircles/{circleId}/audio/{fileName} {
      allow read, write: if request.auth != null && isMemberOfCircle(circleId);
    }
  }
}
