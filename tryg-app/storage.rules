rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is member of a circle (must be defined inside match /b/{bucket}/o for Storage rules)
    function isMemberOfCircle(circleId) {
      // Note: Use (default) for the database name in Storage rules
      return firestore.exists(/databases/(default)/documents/careCircleMemberships/$(circleId + '_' + request.auth.uid));
    }

    // Care circle photos - members can read/write
    match /careCircles/{circleId}/photos/{fileName} {
      allow read, write: if request.auth != null && isMemberOfCircle(circleId);
    }
    
    // Care circle settings (reward photos, etc.)
    match /careCircles/{circleId}/settings/{fileName} {
      allow read, write: if request.auth != null && isMemberOfCircle(circleId);
    }
  }
}
