# Session Handoff - 2025-12-17

## Project State
- **Current branch**: `main`
- **Last commit**: `bde61f0` - refactor: Complete TypeScript migration - convert contexts, animations, fix prop types
- **Dev server**: `npm run dev` (running at localhost:5173)

---

## Changes Made This Session

| File | Change |
|------|--------|
| `src/AppCore.tsx` | Disabled LivingBackground (temp), restructured header: Share/Settings/Logout, pass memberStatuses to orbit |
| `src/components/BottomNavigation.tsx` | Changed from `absolute` to `sticky` positioning, reduced padding |
| `src/components/RelativeView.tsx` | Removed `overflow-hidden`, removed duplicate settings button, added ThinkingOfYouIconButton to header |
| `src/components/SeniorView.tsx` | Removed `overflow-hidden` |
| `src/components/PeaceOfMindTab.tsx` | Removed ThinkingOfYouIconButton (moved to header) |
| `src/features/familyPresence/SuperpowerBadge.tsx` | Added React Portal for modal, centered modal instead of bottom sheet |
| `src/features/familyPresence/FamilyConstellation.tsx` | Added `getArchetype()` fallback function, always show badges |
| `docs/LEARNINGS.md` | Added 5 new learnings: LivingBackground, sticky nav, React Portal, data flow, debugging methodology |
| `docs/CHANGELOG.md` | Added v1.14.0 with all layout fixes |

---

## Key Patterns Discovered

### 1. CSS Positioning in Scroll Containers
- **`absolute bottom-0`** positions at bottom of **scroll content**, not viewport
- **`sticky bottom-0`** is correct for bottom nav inside scrollable areas

### 2. React Portal for Modals
- Any modal inside transformed/filtered parent MUST use `createPortal(modal, document.body)`
- The orbit has CSS transforms that break `fixed` positioning

### 3. LivingBackground Layout Issue
- The animated background component breaks scroll and positioning
- **Root cause**: Likely `overflow: hidden` or incorrect positioning affecting children
- **Current state**: DISABLED, replaced with simple gradient
- **TODO**: Refactor LivingBackground to use `position: absolute; inset: 0`

### 4. Data Flow: Two Member Collections
```
useCareCircle → members (careCircleMemberships) → NO archetype
useMemberStatus → memberStatuses (memberStatuses subcollection) → HAS archetype
```
- Use `memberStatuses` when you need archetype badges

---

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Disabled LivingBackground | Causing multiple layout/scroll bugs; isolate to continue development |
| Sticky instead of absolute for bottom nav | Correct CSS for fixed-bottom inside scroll containers |
| React Portal for badge modal | Required to escape CSS transform context in orbit |
| Pass memberStatuses instead of members to orbit | That's where archetype data lives in Firestore |
| Remove duplicate settings button | Now in central AppCore status bar |

---

## ⚠️ CRITICAL: TypeScript Error Source

### The Refactor Timeline

| Phase | What Happened | Result |
|-------|---------------|--------|
| **Before Dec 17** | Feature folders created, `.jsx` files | ✅ **LAST SAFE BUILD** |
| **Dec 17 (earlier)** | Mass `.jsx` → `.tsx` rename across codebase | ⚠️ **Type errors introduced** |
| **Dec 17 (later)** | CVA + cn() adoption | ⚠️ More refactoring |
| **Dec 17 (this session)** | Layout/CSS/Portal fixes | Fixing symptoms, not root cause |

### Why Errors Keep Appearing

The TypeScript migration was done as a **mass rename** without incremental verification:
1. Many props interfaces don't match actual usage
2. Callers and callees have type mismatches
3. `null` vs `undefined` inconsistencies throughout
4. Generic types like `Set<unknown>` instead of `Set<string>`

**See `docs/LEARNINGS.md` → "Refactor Timeline & Error Source" for recovery options.**

---

## Active Issues

### High Priority
- [x] Bottom navigation positioning - FIXED
- [x] Scroll not working in views - FIXED
- [x] Badges not showing in orbit - FIXED
- [x] Badge modal positioning broken - FIXED
- [ ] **LivingBackground needs refactor** - Currently disabled
- [ ] **TypeScript errors need systematic fix** - Root cause of recurring issues

### Pre-existing TypeScript Errors
The following errors exist but are NOT from this session:
- `RelativeView.tsx`: Type mismatches in `onSendPing`, `onToggleLike`, `onReply` props
- `RelativeView.tsx`: `Set<unknown>` not assignable to `Set<string>`
- `AppCore.tsx`: Argument type mismatches for string | undefined → string | null
- `WordGame.tsx`: `currentWord.options` possibly undefined

Run `tsc --noEmit` to see full list.

---

## Documentation Status

| Doc | Status |
|-----|--------|
| `LEARNINGS.md` | ✅ Updated with today's layout and refactor learnings |
| `CHANGELOG.md` | ✅ Updated with v1.14.0 changes |
| `DEPENDENCIES.md` | ✅ Updated with `.tsx` extensions and TypeScript hooks |
| `ARCHITECTURE.md` | ✅ Updated with migration completion status |
| `Background.md` | ✅ Up to date |
| `CONTRIBUTING.md` | ✅ Up to date |

---

## File Structure Key Points

```
src/
├── AppCore.tsx          # Main app shell (header, frame, providers)
├── components/
│   ├── RelativeView.tsx # Relative's full UI (tabs: daily, family, rapport, spil)
│   ├── SeniorView.tsx   # Senior's full UI (same tabs)
│   ├── BottomNavigation.tsx # Shared bottom nav (STICKY positioning)
│   └── PeaceOfMindTab.tsx   # "Min dag" tab content
├── features/
│   └── familyPresence/
│       ├── FamilyConstellation.tsx # Orbit visualization (receives memberStatuses)
│       └── SuperpowerBadge.tsx     # Badge with PORTAL modal
```

---

## Quick Start for Next Session

1. **Start dev server**: `npm run dev`
2. **Login**: Use test accounts:
   - Relative: `louise.relative@test.com` / `Test1234!`
   - Another relative: `fatima@test.com` / (check Firestore)
   - Senior: Brad Pitt account in Firestore

3. **Current focus**: LivingBackground refactor (if resuming UI work)

4. **Before making changes**: Run `tsc --noEmit` to see baseline TypeScript errors

5. **Key files to review**:
   - `docs/LEARNINGS.md` - Critical debugging knowledge
   - `docs/ARCHITECTURE.md` - System structure
   - `.agent/workflows/` - Available workflows

---

## Critical Warnings for Next Agent

> ⚠️ **DO NOT USE `overflow-hidden`** on view containers if children need to scroll!

> ⚠️ **Always use React Portal** for modals in complex UI with transforms!

> ⚠️ **Check which hook/collection** provides your data before assuming a field is missing!

> ⚠️ **Test scroll behavior** immediately after adding any animated/complex background component!

---

## Session Statistics
- **Duration**: ~3 hours
- **Issues fixed**: 5 major (bottom nav, scroll, header, badges, modal)
- **Iterations on bottom nav**: Too many (documented as lesson learned)
- **Root cause of most issues**: LivingBackground component

---

*Handoff prepared: 2025-12-17 23:00 CET*
