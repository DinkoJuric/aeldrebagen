# Session Handoff - 2025-12-18

## Project State
- **Current branch**: `main`
- **Last commit**: `c87124c` - feat(i18n): add translations for symptoms and gaming corner
- **Dev server**: `cd tryg-app && npm run dev`
- **Build status**: âœ… SUCCESS (vite build exits clean)

---

## Changes Made This Session

### ğŸ™ï¸ Livshistorier (Family Heirloom) Feature
| File | Change |
|------|--------|
| `src/features/memories/AudioRecorder.tsx` | **NEW** - Modular audio recording component with visual feedback |
| `src/features/memories/useMemories.ts` | **NEW** - Hook for Firebase Storage uploads and Firestore records |
| `src/features/memories/MemoriesGallery.tsx` | **NEW** - Life Book gallery for relatives to browse memories |
| `src/features/weeklyQuestion/WeeklyQuestionWidget.tsx` | Added text/audio toggle, AudioRecorder integration, audio playback |
| `src/features/weeklyQuestion/useWeeklyQuestions.ts` | Added `audioUrl` field to `WeeklyAnswer` type |
| `src/components/CoordinationTab.tsx` | Added `MemoriesGallery` in Coordination tab |
| `docs/Livshistorier.md` | **NEW** - Feature walkthrough document |

### ğŸŒ i18n Expansion (Symptoms + Gaming Corner)
| File | Change |
|------|--------|
| `src/locales/da.json` | Added 65+ new translation keys (symptoms, gaming, audio recorder) |
| `src/locales/bs.json` | Added Bosnian translations |
| `src/locales/tr.json` | Added Turkish translations |
| `src/features/wordGame/Spillehjoernet.tsx` | Added i18n support - title/subtitle now use `t()` |
| `src/features/wordGame/WordGame.tsx` | Full i18n overhaul - all game messages use `t()` |
| `src/features/symptoms/BodyPainSelector.tsx` | Added i18n support - body regions, severity, UI text |
| `src/data/constants.ts` | Added `getSymptomsList(t)` factory function for localized symptoms |

### ğŸ› ï¸ Previous Session (Dec 17) - Layout Fixes
| File | Change |
|------|--------|
| `src/AppCore.tsx` | Disabled LivingBackground (temp), restructured header |
| `src/components/BottomNavigation.tsx` | Changed from `absolute` to `sticky` positioning |
| `src/features/familyPresence/SuperpowerBadge.tsx` | Added React Portal for modal |
| `src/features/familyPresence/FamilyConstellation.tsx` | Added `getArchetype()` fallback |

---

## Key Patterns Discovered

### Audio Recording Pattern
```typescript
// AudioRecorder component handles:
// 1. MediaRecorder API for recording
// 2. Visual feedback during recording (pulse animation)
// 3. Playback before submission
// 4. Blob passed to parent via onRecordingComplete callback

const [audioBlob, setAudioBlob] = useState<Blob | null>(null);
<AudioRecorder 
    onRecordingComplete={(blob) => setAudioBlob(blob)} 
    onReset={() => setAudioBlob(null)}
/>
```

### i18n Pattern for Static Data Arrays
```typescript
// Factory function that takes translation function
export const getSymptomsList = (t: (key: string) => string): SymptomOption[] => [
    { id: 'pain', label: t('symptom_pain'), icon: Zap, color: 'bg-red-100 text-red-600' },
];

// Usage in component
const { t } = useTranslation();
const symptoms = getSymptomsList(t);
```

### CSS Positioning in Scroll Containers
- **`absolute bottom-0`** positions at bottom of **scroll content**, not viewport
- **`sticky bottom-0`** is correct for bottom nav inside scrollable areas

### React Portal for Modals
- Any modal inside transformed/filtered parent MUST use `createPortal(modal, document.body)`
- The orbit has CSS transforms that break `fixed` positioning

---

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Audio stored in Firebase Storage, metadata in Firestore | Separates large binary files from structured data |
| `audioUrl` field added to `WeeklyAnswer` type | Minimal schema change, backwards compatible |
| Text/Audio toggle in modal | Gives seniors choice without overwhelming UI |
| Kept static Danish exports alongside factory functions | Backwards compatibility for components not yet updated |
| Disabled LivingBackground | Causing multiple layout/scroll bugs; isolate to continue development |
| Sticky instead of absolute for bottom nav | Correct CSS for fixed-bottom inside scroll containers |
| React Portal for badge modal | Required to escape CSS transform context in orbit |

---

## Active Issues

- [ ] **`uploadMemory` is declared but never read** in `WeeklyQuestionWidget.tsx` - audio upload logic pending full integration
- [ ] **LivingBackground needs refactor** - Currently disabled
- [ ] **Pre-existing TypeScript Lint Errors** (NOT from this session):
  - `Spillehjoernet.tsx` line 48: `submitAnswer` return type mismatch
  - `WordGame.tsx` line 163: `currentWord.options` possibly undefined
  - `RelativeView.tsx`: Type mismatches in `onSendPing`, `onToggleLike`, `onReply` props
- [ ] **Components still using static (Danish) data**:
  - `SYMPTOMS_LIST` imports need migration to `getSymptomsList(t)`
  - `SENIOR_OFFERS`, `RELATIVE_REQUESTS` in helpExchange still hardcoded
  - Status options in `src/features/familyPresence/StatusCard.tsx`

---

## Quick Start for Next Session

1. Run `cd tryg-app && npm run dev`
2. **Test Livshistorier**: Open Weekly Question as Senior â†’ Toggle to "FortÃ¦l" â†’ Record audio
3. **Complete audio upload**: Wire `uploadMemory` in `WeeklyQuestionWidget.tsx` to actually upload the blob
4. **Continue i18n**: Audit remaining hardcoded Danish text:
   - `src/features/helpExchange/config.ts`
   - `src/features/familyPresence/StatusCard.tsx`
5. **Login**: Use test accounts:
   - Relative: `louise.relative@test.com` / `Test1234!`
   - Senior: Brad Pitt account in Firestore

---

## Critical Warnings for Next Agent

> âš ï¸ **DO NOT USE `overflow-hidden`** on view containers if children need to scroll!

> âš ï¸ **Always use React Portal** for modals in complex UI with transforms!

> âš ï¸ **Check which hook/collection** provides your data before assuming a field is missing!

> âš ï¸ **Test scroll behavior** immediately after adding any animated/complex background component!

---

## Troubleshooting Cheat Sheet
| Issue | Potential Cause | Fix Reference |
|-------|----------------|---------------|
| Scroll is broken | `LivingBackground` active | `docs/LEARNINGS.md` |
| Bottom nav floating | `absolute` instead of `sticky` | `src/components/BottomNavigation.tsx` |
| Modal in wrong place | Orbit CSS Transforms | Use `createPortal` (see `SuperpowerBadge.tsx`) |
| Missing archetype badge| Data source mismatch | Pass `memberStatuses` not `members` |

*Handoff prepared: 2025-12-18 02:40 CET*


# Session Handoff - 2025-12-18

## Project State
- **Current branch**: `main`
- **Last commit**: `4172291` - feat: Add Livshistorier (Family Heirloom) audio recording feature
- **Dev server**: `cd tryg-app && npm run dev`
- **Build status**: âœ… SUCCESS (vite build exits clean)

## Changes Made This Session

| File | Change |
|------|--------|
| `src/locales/da.json` | Added 45+ new translation keys for symptoms + gaming corner |
| `src/locales/bs.json` | Added Bosnian translations for symptoms + gaming corner |
| `src/locales/tr.json` | Added Turkish translations for symptoms + gaming corner |
| `src/features/wordGame/Spillehjoernet.tsx` | Added i18n support - title/subtitle now use `t()` |
| `src/features/wordGame/WordGame.tsx` | Full i18n overhaul - all game messages use `t()` |
| `src/features/symptoms/BodyPainSelector.tsx` | Added i18n support - body regions, severity, UI text |
| `src/data/constants.ts` | Added `getSymptomsList(t)` function for localized symptoms |

## Key Patterns Discovered

### i18n Pattern for Static Data Arrays
When data arrays (like body regions, symptoms) need translation:
```typescript
// BAD: Static array with hardcoded labels
export const BODY_REGIONS = [{ id: 'head', label: 'Hoved' }];

// GOOD: Factory function that takes translation function
export const getBodyRegions = (t: (key: string) => string): BodyRegion[] => [
    { id: 'head', label: t('body_head') },
];

// Usage in component
const { t } = useTranslation();
const bodyRegions = getBodyRegions(t);
```

### Backwards Compatibility
When refactoring for i18n, keep original static exports (Danish fallback) for components that haven't been updated yet. This prevents breaking changes during incremental migration.

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Created factory functions (`getBodyRegions`, `getSeverityLevels`, `getSymptomsList`) | Allows passing `t()` function for dynamic translation while preserving static exports for backwards compatibility |
| Kept `BODY_REGIONS`, `SEVERITY_LEVELS`, `SYMPTOMS_LIST` as-is | Components not yet updated still expect static arrays; prevents breaking changes |
| Used translation keys with clear prefixes (`body_`, `symptom_`, `severity_`) | Makes it easy to identify which domain a translation belongs to |

## Active Issues

- [ ] **Pre-existing TypeScript Lint Errors** (NOT from this session):
  - `Spillehjoernet.tsx` line 48: `submitAnswer` return type doesn't match `onAnswer` prop type
  - `WordGame.tsx` line 163: `currentWord.options` possibly undefined
  - These are cosmetic type issues that don't cause runtime problems

- [ ] **Components still using static (Danish) data**:
  - Any component importing `SYMPTOMS_LIST` directly instead of using `getSymptomsList(t)`
  - Need to audit and update components one by one

## Translation Keys Added

### Gaming Corner (SpillehjÃ¸rnet)
| Key | Danish | Bosnian | Turkish |
|-----|--------|---------|---------|
| `spillehjoernet_title` | SpillehjÃ¸rnet | Igraonica | Oyun KÃ¶ÅŸesi |
| `spillehjoernet_subtitle` | Dagens ordleg... | Dnevna igra... | Aile ile gÃ¼nlÃ¼k... |
| `word_game_complete` | Dagens ord er klaret! | Danas su rijeÄi zavrÅ¡ene! | GÃ¼nÃ¼n kelimeleri tamamlandÄ±! |
| `answer_correct` | Helt rigtigt! ğŸ‰ | Potpuno taÄno! ğŸ‰ | Tamamen doÄŸru! ğŸ‰ |
| + 10 more game-related keys | ... | ... | ... |

### Symptoms
| Key | Danish | Bosnian | Turkish |
|-----|--------|---------|---------|
| `symptom_pain` | Smerter | Bol | AÄŸrÄ± |
| `body_head` | Hoved | Glava | BaÅŸ |
| `severity_mild` | Lidt | Malo | Az |
| + 15 more symptom-related keys | ... | ... | ... |

## Quick Start for Next Session

1. Run `cd tryg-app && npm run dev`
2. The current focus is **completing i18n coverage**
3. Start by looking at components that still import `SYMPTOMS_LIST` directly:
   - Audit with: `grep -r "SYMPTOMS_LIST" src/`
   - Update each to use `getSymptomsList(t)` instead
4. Also check for remaining hardcoded Danish text in:
   - `src/features/helpExchange/config.ts` (SENIOR_OFFERS, RELATIVE_REQUESTS, etc.)
   - Status options in `src/features/familyPresence/StatusCard.tsx`

---

# Session Update - 2025-12-18 (03:15 CET)

## Latest Commit
- **Commit**: `8d5d5e0` - feat: unified settings modal and global navigation refactoring
- **Build status**: âœ… SUCCESS

## Changes Made This Session

### âš™ï¸ Settings Integration & Navigation Refactoring
| File | Change |
|------|--------|
| `src/components/SettingsModal.tsx` | **NEW** - Unified settings modal with language selection, family circle, and privacy controls |
| `src/AppCore.tsx` | Lifted `activeTab` state to top-level, added global `BottomNavigation`, integrated `SettingsModal` |
| `src/components/SeniorView.tsx` | Removed internal `activeTab` state, removed redundant `LanguageSwitcher` and `BottomNavigation` |
| `src/components/RelativeView.tsx` | Removed internal `activeTab` state, removed `LanguageSwitcher`, fixed period selector (added all 4 periods) |
| `src/features/photos/PhotoShare.tsx` | Added `isOpen` and `onClose` props to `PhotoViewerModal`, added close button |

### ğŸŒ i18n Updates (User-provided)
| File | Change |
|------|--------|
| `src/locales/da.json` | Added 40+ new keys (symptoms, gaming corner, settings UI, body parts, severity levels) |
| `src/locales/bs.json` | Added Bosnian translations for new keys |
| `src/locales/tr.json` | Added Turkish translations for new keys |
| `src/data/constants.ts` | Added `getSymptomsList(t)` and `SymptomOption` type for localized symptoms |

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Unified settings in modal instead of dropdown | Cleaner UX, centralizes language, family, and privacy controls |
| Lifted `activeTab` to `AppCore.tsx` | Ensures both Senior and Relative views share navigation state |
| Removed `LanguageSwitcher` from individual views | Now accessible only via unified Settings modal |
| Fixed RelativeView period selector | Was missing Morning, Lunch, Afternoon options - now has all 4 |
| Added `isOpen`/`onClose` to `PhotoViewerModal` | Required for proper modal control from parent component |

## Architecture Changes

### Before
```
AppCore
â”œâ”€â”€ SeniorView (owns activeTab, has LanguageSwitcher, BottomNavigation)
â””â”€â”€ RelativeView (owns activeTab, has LanguageSwitcher, RelativeBottomNavigation)
```

### After
```
AppCore (owns activeTab, BottomNavigation, SettingsModal)
â”œâ”€â”€ SeniorView (receives activeTab via props)
â””â”€â”€ RelativeView (receives activeTab via props)
```

## How to Add More Languages

1. **Create locale file**: Copy `src/locales/da.json` to `src/locales/{lang}.json`
2. **Translate all keys**: Update values in new file
3. **Register in i18n**: Add import in `src/i18n.ts`:
   ```typescript
   import newLang from './locales/{lang}.json';
   // Add to resources object
   ```
4. **Add to switcher**: Update `src/components/LanguageSwitcher.tsx`:
   ```typescript
   const LANGUAGES = [
     { code: 'da', name: 'Dansk', flag: 'ğŸ‡©ğŸ‡°' },
     { code: '{lang}', name: 'Language Name', flag: 'ğŸ³ï¸' },
   ];
   ```

*Handoff updated: 2025-12-18 03:15 CET*


# Session Update - 2025-12-18 (04:00 CET)

## Latest Commit
- **Commit**: `fc32500` - feat(i18n): harmonize codebase after Voice, Coffee, I18n merge
- **Build status**: âœ… SUCCESS

## Changes Made This Session

### â˜• Spontan Kaffe (Open Door) Feature
| File | Change |
|------|--------|
| `src/features/coffee/CoffeeToggle.tsx` | **NEW** - Senior-facing toggle to signal "coffee is ready" |
| `src/features/coffee/CoffeeInviteCard.tsx` | **NEW** - Relative-facing invitation card with "I'm coming!" action |
| `src/features/coffee/index.ts` | **NEW** - Public API barrel export |
| `src/types.ts` | Added `coffee_ready` and `coffee_coming` to Member status union |
| `src/features/thinkingOfYou/usePings.ts` | Extended `Ping` with optional `type` and `message` fields |
| `src/components/SeniorView.tsx` | Integrated `CoffeeToggle` in Family tab, fixed match logic |
| `src/components/PeaceOfMindTab.tsx` | Integrated `CoffeeInviteCard` at top of feed, cleaned unused vars |
| `src/contexts/CareCircleContext.tsx` | Unified types from `types.ts`, removed redundant local definitions |
| `docs/Idea_Spontan_Kaffe.md` | **NEW** - Feature specification doc |

### ğŸŒ i18n Expansion (Coffee Feature + Briefings)
| File | Change |
|------|--------|
| `src/locales/da.json` | Added 27 new translation keys (coffee, peace of mind, daily briefings) |
| `src/locales/bs.json` | Added Bosnian translations for all new keys |
| `src/locales/tr.json` | Added Turkish translations for all new keys |
| `src/utils/briefing.ts` | Refactored to accept `t` function for localized daily summaries |

## Key Patterns Discovered

### CareCircleContext State Sharing
```typescript
// Unified types in types.ts, consumed by context
export interface CareCircleContextValue {
    careCircleId: string | null;
    currentUserId: string | null;
    userName: string;
    myStatus: MemberStatus | null;
    setMyStatus: (status: string) => Promise<void>;
    memberStatuses: MemberStatus[];
    seniorStatus: MemberStatus | null;
    seniorName: string;
}

// Components access via hook
const { setMyStatus, seniorStatus } = useCareCircleContext();
```

### Ping System Extension
The `usePings` hook now supports typed notifications:
```typescript
sendPing(userName, currentUserId, 'relative', 'coffee_invite', t('coffee_coming_msg', { name: userName }));
```

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Created `features/coffee/` module | Isolates feature for easy maintenance, follows existing pattern |
| Extended `usePings` vs new hook | `usePings` already handles notifications; adding type/message avoids duplication |
| Unified types in `types.ts` | Eliminates multiple `CareCircleContextValue` definitions causing lint errors |
| Coffee toggle in Family tab | Natural grouping with other social features (Thinking of You, Family Presence) |
| Coffee invite at top of Peace of Mind | High visibility for time-sensitive social invitations |

## Architecture Changes

### Before
```
types.ts        â†’ Basic Member, UserProfile types
CareCircleContext.tsx â†’ Had own CareCircleContextValue interface
usePings.ts     â†’ Basic ping (fromName, toRole, sentAt)
```

### After
```
types.ts        â†’ Unified CareCircleContextValue + extended Member.status
CareCircleContext.tsx â†’ Imports from types.ts, no local interfaces
usePings.ts     â†’ Extended Ping with type?, message? fields
features/coffee/ â†’ New modular feature with CoffeeToggle, CoffeeInviteCard
```

## Active Issues

- [ ] **Pre-existing TypeScript Lint Errors** (NOT from this session):
  - `Spillehjoernet.tsx` line 48: `submitAnswer` return type mismatch
  - `WordGame.tsx` line 163: `currentWord.options` possibly undefined
- [ ] **Components still using static (Danish) data**:
  - `SENIOR_OFFERS`, `RELATIVE_REQUESTS` in helpExchange still hardcoded
  - Status options in `src/features/familyPresence/StatusCard.tsx`

## Quick Start for Next Session

1. Run `cd tryg-app && npm run dev`
2. **Test Spontan Kaffe**: 
   - Senior: Toggle coffee pot in Family tab â†’ Check that relatives see invite
   - Relative: Tap "Jeg kigger forbi" â†’ Verify senior sees "Nogen er pÃ¥ vej!"
3. **Continue i18n**: Audit remaining hardcoded Danish text:
   - `src/features/helpExchange/config.ts` (SENIOR_OFFERS, RELATIVE_REQUESTS)
   - `src/features/familyPresence/StatusCard.tsx` (status options)
4. **Login**: Use test accounts:
   - Relative: `louise.relative@test.com` / `Test1234!`

## Translation Keys Added

### Coffee Feature (Spontan Kaffe)
| Key | Danish | Turkish | Bosnian |
|-----|--------|---------|---------|
| `coffee_coming_msg` | {{name}} kigger forbi til kaffe! â˜•ï¸ | {{name}} kahveye uÄŸruyor! â˜•ï¸ | {{name}} dolazi na kafu! â˜•ï¸ |
| `status_coffee_ready` | Kaffen er klar! | Kahve hazÄ±r! | Kafa je spremna! |
| `coffee_give_button` | Giv kaffe? | Kahve ikram et? | HoÄ‡eÅ¡ li dati kafu? |
| `coffee_coming_title` | Nogen er pÃ¥ vej! ğŸš— | Birisi yolda! ğŸš— | Neko je na putu! ğŸš— |
| `coffee_invite_title` | {{name}} giver kaffe! â˜•ï¸ | {{name}} kahve Ä±smarlÄ±yor! â˜•ï¸ | {{name}} Äasti kafom! â˜•ï¸ |
| `coffee_invite_accept` | Jeg kigger forbi | UÄŸrayacaÄŸÄ±m | SvratiÄ‡u |

### Daily Briefings
| Key | Danish |
|-----|--------|
| `daily_briefing_all_fine` | Alt er som det skal vÃ¦re. {{name}} har taget sin medicin... |
| `daily_briefing_meds_fine` | {{name}} har taget sin medicin og har det godt. ğŸ’š |
| `daily_briefing_no_activity` | Ingen aktivitet endnu i dag. {{name}} sover mÃ¥ske lÃ¦nge? ğŸ’¤ |

*Handoff updated: 2025-12-18 04:00 CET*
