<!DOCTYPE html>
<html>

<body style="background: pink;">
    <h2>Extraction Station</h2>
    <!-- Cache bust the image to ensure reload -->
    <img id="source" src="/assets/sprites/family-presence.png" crossorigin="anonymous" />
    <canvas id="canvas" style="border: 1px solid red;"></canvas>
    <div id="output"></div>
    <div id="status">Waiting...</div>
    <script>
        const img = document.getElementById('source');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const output = document.getElementById('output');
        const status = document.getElementById('status');

        function process() {
            status.innerText = "Processing...";
            const w = img.naturalWidth;
            const h = img.naturalHeight;

            if (w === 0) {
                status.innerText = "Error: Image width 0";
                return;
            }

            // Grid: 4 cols, 2 rows.
            const spriteW = w / 4;
            const spriteH = h / 2;

            canvas.width = spriteW;
            canvas.height = spriteH;

            // Beanie Man: 3rd column (index 2), 1st row (index 0)
            // Coordinates: x = 2 * spriteW, y = 0

            ctx.drawImage(img, 2 * spriteW, 0, spriteW, spriteH, 0, 0, spriteW, spriteH);

            try {
                const dataURL = canvas.toDataURL('image/png');
                output.innerText = dataURL.split(',')[1];
                status.innerText = "Done";
            } catch (e) {
                status.innerText = "Canvas Security Error: " + e.message;
            }
        }

        if (img.complete) {
            setTimeout(process, 500);
        } else {
            img.onload = () => setTimeout(process, 500);
            img.onerror = () => status.innerText = "Error loading image";
        }
    </script>
</body>

</html>